<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Al Jazeera Documentary Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      body {
        font-family: "Cairo", sans-serif;
      }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .scrollbar-thin {
    -ms-overflow-style: thin;
    scrollbar-width: thin;
  }
</style>
  </head>
  <body class="flex flex-col h-screen p-4 bg-gray-900" id="pageBody" dir="ltr">
    <div class="flex-none">
    <div class="flex justify-between items-center mb-4 px-4 py-3 bg-gray-800">
      <h1 class="text-xl font-bold text-white" id="title">Al Jazeera Documentary Chat</h1>
      <div class="flex items-center gap-3">
<!--         <span id="modeLabel" class="px-2 py-1 rounded text-white text-sm bg-green-600">Mock Mode</span> -->
<!--         <button id="toggleMode" class="px-3 py-1 rounded-lg border bg-white text-sm">Toggle</button> -->
        <button id="clearChat" class="px-3 py-1 rounded-lg bg-red-500 text-white text-sm">Clear Chat</button>
        <button id="toggleLang" class="px-3 py-1 rounded-lg bg-gray-700 text-white text-sm">Ø¹Ø±Ø¨ÙŠ</button>
      </div>
    </div>
    </div>

    <div class="max-w-3xl mx-auto flex-1 flex flex-col min-h-0">
      <div id="chatLog" class="flex-1 overflow-y-auto rounded-lg p-3 space-y-4 scrollbar-thin"></div>
  
      <div class="flex mt-3">
        <textarea id="chatInput" placeholder="Type your message..." class="flex-1 border rounded-lg px-3 py-2 resize-none bg-gray-600 text-white" rows="2"></textarea>
        <button id="sendBtn" class="ml-2 px-4 py-2 bg-blue-500 text-white rounded-lg">Send</button>
      </div>
      
    </div>


    <script>
      let useMock = false
      const backendUrl = 'https://icons.1px.workers.dev/chat'
      let history = JSON.parse(localStorage.getItem('ajdChatHistory') || '[]')
      let currentLang = localStorage.getItem('ajdChatLang') || 'en' // default English

      const translations = {
        en: {
          title: 'Al Jazeera Documentary Chat',
          welcome: 'ðŸ‘‹ Welcome! This is Al Jazeera Documentary Explorer. You can use it to find your next idea.',
          send: 'Send',
          clear: 'Clear Chat',
          mock: 'Mock Mode',
          backend: 'Backend Mode',
          toggleLang: 'Ø¹Ø±Ø¨ÙŠ',
          placeholder: 'Type your message...'
        },
        ar: {
          title: 'Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¬Ø²ÙŠØ±Ø© Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ÙŠØ©',
          welcome: 'ðŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹! Ù‡Ø°Ù‡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø²ÙŠØ±Ø© Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ÙŠØ© .',
          send: 'Ø¥Ø±Ø³Ø§Ù„',
          clear: 'Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©',
          mock: 'ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©',
          backend: 'ÙˆØ¶Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù…',
          toggleLang: 'English',
          placeholder: 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...'
        }
      }

      function setLanguage(lang) {
        currentLang = lang
        localStorage.setItem('ajdChatLang', lang)
        const t = translations[lang]
        $('#title').text(t.title)
        $('#clearChat').text(t.clear)
        $('#sendBtn').text(t.send)
        $('#toggleLang').text(t.toggleLang)
        $('#chatInput').attr('placeholder', t.placeholder)
        $('#modeLabel').text(useMock ? t.mock : t.backend)

        if (lang === 'ar') {
          $('#pageBody').attr('dir', 'rtl')
        } else {
          $('#pageBody').attr('dir', 'ltr')
        }
      }

      // Load existing messages from localStorage
      $(document).ready(() => {
        setLanguage(currentLang)
        if (history.length === 0) {
          const welcome = translations[currentLang].welcome
          appendMessage('assistant', welcome)
          addToHistory('assistant', welcome)
        } else {
          history.forEach(msg => appendMessage(msg.role, msg.content))
        }
      })

      function appendMessage(role, content) {
        const alignment = role === 'user' ? 'text-right bg-white text-gray-900' : 'text-left bg-gray-700 text-white';

          // Parse markdown and sanitise HTML
  const htmlContent = marked.parse(content);

          $('#chatLog').append(
    `<div class="p-5 rounded-lg ${alignment}">` +
    `<div style="white-space: pre-wrap">${htmlContent}</div>` +
    `</div>`
  );
  $('#chatLog').scrollTop($('#chatLog')[0].scrollHeight);
        
        // $('#chatLog').append(`<div class="p-2 rounded-lg ${alignment}"><div style="white-space: pre-wrap">${content}</div></div>`)
        // $('#chatLog').scrollTop($('#chatLog')[0].scrollHeight)
      }

      function addToHistory(role, content) {
        history.push({ role, content })
        localStorage.setItem('ajdChatHistory', JSON.stringify(history))
      }

      function clearChat() {
        history = []
        localStorage.removeItem('ajdChatHistory')
        $('#chatLog').empty()
        const welcome = translations[currentLang].welcome
        appendMessage('assistant', welcome)
        addToHistory('assistant', welcome)
      }

      $('#toggleMode').click(() => {
        useMock = !useMock
        const t = translations[currentLang]
        if (useMock) {
          $('#modeLabel').text(t.mock).removeClass('bg-purple-600').addClass('bg-green-600')
        } else {
          $('#modeLabel').text(t.backend).removeClass('bg-green-600').addClass('bg-purple-600')
        }
      })

      $('#clearChat').click(clearChat)

      $('#toggleLang').click(() => {
        const newLang = currentLang === 'en' ? 'ar' : 'en'
        setLanguage(newLang)
        clearChat() // reset with new language welcome message
      })

      $('#sendBtn').click(sendMessage)
      $('#chatInput').keypress(e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault()
          sendMessage()
        }
      })

      function sendMessage() {
        const text = $('#chatInput').val().trim()
        if (!text) return
        appendMessage('user', text)
        addToHistory('user', text)
        $('#chatInput').val('')

          // Add loading message
  const loadingId = 'loading-' + Date.now()
  const loadingMsg = currentLang === 'ar' 
    ? '...ÙŠØ¨Ø­Ø«ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' 
    : 'Searching, please wait...'
  $('#chatLog').append(`<div id="${loadingId}" class="p-2 rounded-lg text-left bg-gray-200">${loadingMsg}</div>`)
  $('#chatLog').scrollTop($('#chatLog')[0].scrollHeight)
        
        if (useMock) {
                // Remove loading message
      $(`#${loadingId}`).remove()
      
          setTimeout(() => {
            const reply = `(Mock GPT) You asked: '${text}'. In backend mode I would analyze Al Jazeera's documentary topics and compare them with your project.`
            appendMessage('assistant', reply)
            addToHistory('assistant', reply)
          }, 600)
        } else {
          fetch(backendUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text, history })
          })
            .then(res => res.json())
            .then(data => {
                      // Remove loading message
        $(`#${loadingId}`).remove()
              
              const reply = data.reply || 'No reply'
              appendMessage('assistant', reply)
              addToHistory('assistant', reply)
            })
            .catch(() => {
                      // Remove loading message
        $(`#${loadingId}`).remove()
              
              const errorMsg = currentLang === 'ar' ? 'Ø®Ø·Ø£: ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….' : 'Error: could not connect to backend server.'
              appendMessage('assistant', errorMsg)
              addToHistory('assistant', errorMsg)
            })
        }
      }
    </script>
  </body>
</html>
